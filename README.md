# üõ†Ô∏è Color-Based Material Classifier with OpenPLC and Arduino

This project consists of an automatic material classification system based on its color, integrating the OpenPLC platform with an Arduino UNO board. The main objective was to create a sorting line where a proximity sensor activates a gear motor, which in turn turns on the conveyor belt when material is received. It identifies the color of the transported material through a color sensor, and two servomotors redirect it to the corresponding compartment based on that color.

## üß∞ Technologies Used

The system is composed of the following elements:

- üéõÔ∏è Gear Motor: Drives a conveyor belt that carries the objects through the system.
- üì¶ Conveyor Belt: Moves the material toward the inspection point and then transports it to a specific compartment.
- üé® TCS34725 Color Sensor: Detects the RGB color of the material as it passes through the sensor.
- üîÑ Arduino UNO: Receives data from the sensor and communicates it to OpenPLC.
- üß† OpenPLC: Responsible for processing the data and, based on the PLC programming and an Arduino code, activates the actuators, which in this case are the servomotors.
- ü§ñ Servomotor: Rotates to a specific angle depending on the detected color, redirecting the material to the corresponding compartment.
- üî¶ E18-D80NK Proximity Sensor: Has the function of activating the conveyor belt when it detects material.
  

## üîÅ  System Logic

- An AGV (Automatic Guided Vehicle) sends the material and the system receives it to classify it according to its characteristics.
- When the material is received, the proximity sensor is activated, as well as the gear motor, causing the material to move toward the color sensor.
- The material passes through the TCS34725 sensor and analyzes the color it has. The options it can detect are blue, green, or yellow.
- Based on the color, a turning angle is defined for the servomotors to classify the material.
- Thanks to the constant movement generated by the conveyor belt and the angle generated by the servomotors, the material is redirected to the assigned compartment.


## üìπ Project Video

[Material Classification](https://youtube.com/shorts/kHZi7zJUA0E?feature=share)


##  Logic of the Code (Arduino Side)

- The libraries for the servomotors and the color sensor are declared:

  ```
  #include <Servo.h> // Library for the servomotor
  #include <Adafruit_TCS34725.h> // Library for the color sensor
   ```
- The color sensor, the servomotors, the angles that will remain constant during code execution, and some variables that we‚Äôll use as flags later in the code are declared:

  ```

  // Color sensor initialization
    Adafruit_TCS34725 tcs = Adafruit_TCS34725(TCS34725_INTEGRATIONTIME_50MS, TCS34725_GAIN_4X);

  // Servomotors initialization
    Servo myservo1;
    Servo myservo2;

  // Defined angles for the servos
  const int Angulo1 = 50; // Puedes trabajar con los angulos 38 y 47 pero es mejor 50 
  const int Angulo2 = 90;
  const int Angulo3 = 135; //138
  
  // Global flag variables
  bool F1 = 0, F2 = 0, F3 = 0, F4 = 0;   // Flags for detected colors
  
- We insert a function to start the execution of the color sensor:
  ```
   if (!tcs.begin()) {
        Serial.println("Sensor TCS34725 no detectado.");
        while (1); // Halt execution if sensor is not detected
    }
- The pin for the servomotors and the angle they should be at is declared:
```
    // Configuraci\xf3n de los servos
    myservo1.attach(15);
    myservo1.write(90); // Initial position
    myservo2.attach(16);
    myservo2.write(90); // Initial position

```
-With this command Serial.begin, serial communication between the Arduino and the computer begins to display the sensor readings:

    Serial.begin(9600); // Serial communication

- Here we declare the variables that we will use to obtain the sensor readings. These readings use the letters RGB because depending on the color detected by the sensor, those are the RGB values obtained:

  ```
   float red, green, blue;
    tcs.getRGB(&red, &green, &blue);
    int R = int(red);
    int G = int(green);
    int B = int(blue);
    String color = "Neutral";

-Calculations are performed with the readings obtained from the sensor, and based on those readings, we create the conditions to display on screen and in the code what color the delivered material is. These operations are calculated with the help of the video linked at the end.
```
  // Detecci\xf3n del color y asignaci\xf3n de flags

    if ((R - G > 10) && (G - B > 60)) { // Amarillo
        color = "Yellow";
        F1 = 1; F2 = 0; F3 = 0; F4 = 0;
    } else if ((G - R > 20) && (G - B > 50)) { // Verde
        color = "Green";
        F1 = 0; F2 = 1; F3 = 0; F4 = 0;
    } else if ((G - R > 10) && (B - G > 20)) { // Azul
        color = "Blue";
        F1 = 0; F2 = 0; F3 = 1; F4 = 0;
    } else { // Neutral
        F1 = 0; F2 = 0; F3 = 0; F4 = 1;
    }

    
// Print values for debugging

    Serial.print("R: "); Serial.print(R);
    Serial.print(" G: "); Serial.print(G);
    Serial.print(" B: "); Serial.print(B);
    Serial.print(" Color: "); Serial.println(color);
```
- Based on the detected color and the code found in the PLC, the program enters the corresponding condition and the materials are classified. A delay is left at the end so that the program doesn‚Äôt activate too quickly:

 ```
//  Servo control based on the active flag
    if (F1 && Servo1_ON) { // Amarillo
        myservo1.write(Angulo1);
        myservo2.write(Angulo1-10);
    } else if (F2 && Servo1_ON) { // Verde
        myservo1.write(Angulo2);
        myservo2.write(Angulo2);
    } else if (F3 && Servo1_ON) { // Azul
        myservo1.write(Angulo3);
        myservo2.write(Angulo3);
    } else if (F4 && !Servo1_ON) { // Neutral
        myservo1.write(90); // Central position 
        myservo2.write(90);
    }

    // Small pause for stability
    delay(100);

```
##   Logic of the Code (PLC Side)

- The configuration of inputs and outputs in OpenPLC can be found on the official website, as each pin of the Arduino board has its own value.
  
- [Click here to see the inputs and outputs in Open PLC](https://autonomylogic.com/docs/2-4-physical-addressing/). The Arduino boards are in the section titled Uno, Nano, Leonardo, Micro, and Zero.
- 
1. We declare the variables that will be inputs and outputs with their respective pins. The variable name "Linterna" represents the proximity sensor, "SERVO1_ON" represents a coil to move the servomotors within the Arduino code, "Paro" represents an emergency stop button in case the system needs to be stopped, and it is normally closed. Finally, "Motor" represents the gear motor that moves the conveyor belt.

   ![Imagen 4](https://github.com/user-attachments/assets/23346f5d-12cb-444e-8c1d-cd160a666a19)

2.  When the AGV appears in front of the conveyor belt, the switch corresponding to the proximity sensor changes from normally open to normally closed, activating the coil that represents the gear motor. This causes the motor to turn on along with the conveyor belt.

  ![Imagen 2](https://github.com/user-attachments/assets/f48cc4fa-b389-4eb5-acc4-6baa9938db38)
   
3. When the coil representing the motor is activated, we move to the next stage in which a TPO-type timer is inserted. This timer has the function of stopping the electrical current for 2 seconds so that the color sensor has enough time to run the Arduino code and recognize the color of the material.

   
4. After the 2 seconds are completed, power is given to the coil that represents the "Sensor1_ON" variable. When this coil is activated, it obtains a value of 1, causing it to enter the conditions that activate the servomotors depending on the color.

   
![Imagen 1](https://github.com/user-attachments/assets/f3678cf5-e125-4419-8341-931d45afaa2c)


  





